<!DOCTYPE html>
<html>
  <head>
    <title>NYC DSNY Geocoding Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .success {
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      .info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
      }
      pre {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 3px;
        overflow-x: auto;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>NYC DSNY Geocoding Integration Test</h1>

    <div class="test-section info">
      <h3>Test Addresses</h3>
      <p>Testing geocoding → DSNY zone lookup for Brooklyn addresses:</p>
      <ul>
        <li>149 Skillman Street, Brooklyn NY 11205</li>
        <li>195 Division Avenue, Brooklyn NY 11211</li>
        <li>183 Wallabout Street, Brooklyn NY 11206</li>
        <li>670 Myrtle Avenue, Brooklyn NY 11205</li>
      </ul>
    </div>

    <button onclick="testGeocoding()">Test Geocoding Integration</button>
    <button onclick="testDirectDSNY()">Test Direct DSNY API</button>
    <button onclick="clearResults()">Clear Results</button>

    <div id="results"></div>

    <script>
      const testAddresses = [
        '149 Skillman Street, Brooklyn NY 11205',
        '195 Division Avenue, Brooklyn NY 11211',
        '183 Wallabout Street, Brooklyn NY 11206',
        '670 Myrtle Avenue, Brooklyn NY 11205',
      ]

      function addResult(title, content, type = 'info') {
        const resultsDiv = document.getElementById('results')
        const section = document.createElement('div')
        section.className = `test-section ${type}`
        section.innerHTML = `<h3>${title}</h3><pre>${content}</pre>`
        resultsDiv.appendChild(section)
      }

      async function testGeocoding() {
        addResult(
          'Starting Geocoding Test',
          'Testing address → coordinates → DSNY zone lookup...',
          'info'
        )

        for (const testAddress of testAddresses) {
          try {
            addResult(`Testing: ${testAddress}`, 'Step 1: Geocoding address...', 'info')

            // Step 1: Geocode
            const geocodeResponse = await fetch(
              `https://api.cityofnewyork.us/geocoding/v1/geocode?address=${encodeURIComponent(
                testAddress
              )}`
            )

            if (geocodeResponse.ok) {
              const geocodeData = await geocodeResponse.json()
              addResult(
                `Geocoding Result for ${testAddress}`,
                JSON.stringify(geocodeData, null, 2),
                'success'
              )

              if (geocodeData && geocodeData.coordinates) {
                const { lat, lng } = geocodeData.coordinates
                addResult(`Coordinates for ${testAddress}`, `Lat: ${lat}, Lng: ${lng}`, 'success')

                // Step 2: Find DSNY zone
                addResult(
                  `DSNY Zone Lookup for ${testAddress}`,
                  'Step 2: Finding DSNY collection zone...',
                  'info'
                )

                const dsnyResponse = await fetch(
                  `https://data.cityofnewyork.us/resource/p7k6-2pm8.json?$where=within_circle(location, ${lat}, ${lng}, 100)&$limit=1`
                )

                if (dsnyResponse.ok) {
                  const dsnyData = await dsnyResponse.json()
                  addResult(
                    `DSNY Zone Data for ${testAddress}`,
                    JSON.stringify(dsnyData, null, 2),
                    'success'
                  )

                  if (dsnyData && dsnyData.length > 0) {
                    const zone = dsnyData[0]
                    const pickupDays = []
                    if (zone.monday) pickupDays.push('Monday')
                    if (zone.tuesday) pickupDays.push('Tuesday')
                    if (zone.wednesday) pickupDays.push('Wednesday')
                    if (zone.thursday) pickupDays.push('Thursday')
                    if (zone.friday) pickupDays.push('Friday')
                    if (zone.saturday) pickupDays.push('Saturday')
                    if (zone.sunday) pickupDays.push('Sunday')

                    addResult(
                      `✅ SUCCESS: ${testAddress}`,
                      `Zone: ${zone.zone_name || zone.zone || 'Unknown'}\n` +
                        `Pickup Days: ${pickupDays.join(', ')}\n` +
                        `Collection Type: ${zone.collection_type || 'refuse'}`,
                      'success'
                    )
                  } else {
                    addResult(
                      `❌ No DSNY zone found for ${testAddress}`,
                      'No collection zone data found for these coordinates',
                      'error'
                    )
                  }
                } else {
                  addResult(
                    `❌ DSNY API Error for ${testAddress}`,
                    `${dsnyResponse.status} ${dsnyResponse.statusText}`,
                    'error'
                  )
                }
              } else {
                addResult(
                  `❌ No coordinates for ${testAddress}`,
                  'Geocoding failed to return coordinates',
                  'error'
                )
              }
            } else {
              addResult(
                `❌ Geocoding Error for ${testAddress}`,
                `${geocodeResponse.status} ${geocodeResponse.statusText}`,
                'error'
              )
            }
          } catch (error) {
            addResult(`❌ Error testing ${testAddress}`, error.message, 'error')
          }
        }
      }

      async function testDirectDSNY() {
        addResult('Testing Direct DSNY API', 'Testing direct access to DSNY dataset...', 'info')

        try {
          // Test 1: Get any Brooklyn data
          const response = await fetch(
            "https://data.cityofnewyork.us/resource/p7k6-2pm8.json?$where=address like '%Brooklyn%'&$limit=3"
          )

          if (response.ok) {
            const data = await response.json()
            addResult('Direct DSNY API Test', JSON.stringify(data, null, 2), 'success')

            if (data && data.length > 0) {
              addResult('✅ DSNY API Working', `Found ${data.length} Brooklyn records`, 'success')
            } else {
              addResult('❌ No Brooklyn Data', 'No Brooklyn records found in DSNY dataset', 'error')
            }
          } else {
            addResult('❌ DSNY API Error', `${response.status} ${response.statusText}`, 'error')
          }
        } catch (error) {
          addResult('❌ DSNY API Test Error', error.message, 'error')
        }
      }

      function clearResults() {
        document.getElementById('results').innerHTML = ''
      }
    </script>
  </body>
</html>
